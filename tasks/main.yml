- name: "Create backup dir"
  tags: always
  file:
    name: /tmp/backup
    state: directory

- name: "Backing up volumes"
  tags: vol_backup
  include: backup.yml
  with_items: "{{ volumes_to_backup }}"

- name: "Retrieve back ups"
  tags: vol_backup
  fetch:
    flat: True
    src: "{{ item }}"
  with_fileglob:
    - /tmp/backup/*.tar.bz2

- name: "Restore from backups"
  tags: "vol_restore"
  include: restore.yml
  with_items: "{{ volumes_to_backup }}"
  loop_control:
    loop_var: vol

- name: "Clean up back up files"
  tags: always
  file:
    name: /tmp/backup
    state: absent
